<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>tapable (2.0.0-beta 版本) | JiZhi</title>
    <meta name="description" content="每天都是充实的一天。">
    
    
    <link rel="preload" href="/blog/assets/css/styles.1527b53c.css" as="style"><link rel="preload" href="/blog/assets/js/app.1527b53c.js" as="script"><link rel="preload" href="/blog/assets/js/19.4459fab3.js" as="script"><link rel="prefetch" href="/blog/assets/js/9.82a5e495.js"><link rel="prefetch" href="/blog/assets/css/1.styles.5a8ea794.css"><link rel="prefetch" href="/blog/assets/js/1.5a8ea794.js"><link rel="prefetch" href="/blog/assets/css/2.styles.354b08d3.css"><link rel="prefetch" href="/blog/assets/js/2.354b08d3.js"><link rel="prefetch" href="/blog/assets/js/3.2f7da517.js"><link rel="prefetch" href="/blog/assets/js/4.9ece7494.js"><link rel="prefetch" href="/blog/assets/js/5.7cbd655d.js"><link rel="prefetch" href="/blog/assets/js/6.5447cf44.js"><link rel="prefetch" href="/blog/assets/js/7.f8177327.js"><link rel="prefetch" href="/blog/assets/js/8.072cd75c.js"><link rel="prefetch" href="/blog/assets/js/10.a4300a64.js"><link rel="prefetch" href="/blog/assets/js/11.671860cc.js"><link rel="prefetch" href="/blog/assets/js/12.6f5779c5.js"><link rel="prefetch" href="/blog/assets/js/13.178f050d.js"><link rel="prefetch" href="/blog/assets/js/14.66b4a5f6.js"><link rel="prefetch" href="/blog/assets/js/15.d96648ea.js"><link rel="prefetch" href="/blog/assets/js/16.df7195c7.js"><link rel="prefetch" href="/blog/assets/js/17.a6c497f0.js"><link rel="prefetch" href="/blog/assets/js/18.fdda8d80.js"><link rel="prefetch" href="/blog/assets/js/20.ccad1215.js"><link rel="prefetch" href="/blog/assets/js/21.da278b03.js">
    <link rel="stylesheet" href="/blog/assets/css/1.styles.5a8ea794.css"><link rel="stylesheet" href="/blog/assets/css/2.styles.354b08d3.css"><link rel="stylesheet" href="/blog/assets/css/styles.1527b53c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">JiZhi</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/code/vue/vuex.html" class="nav-link">编程</a></div><div class="nav-item"><a href="/blog/books/literature/lostParadise.html" class="nav-link">书籍</a></div><div class="nav-item"><a href="/blog/articles/index.html" class="nav-link">文章</a></div><div class="nav-item"><a href="/blog/sources/index.html" class="nav-link">资源</a></div><div class="nav-item"><a href="https://github.com/theniceangel" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/code/vue/vuex.html" class="nav-link">编程</a></div><div class="nav-item"><a href="/blog/books/literature/lostParadise.html" class="nav-link">书籍</a></div><div class="nav-item"><a href="/blog/articles/index.html" class="nav-link">文章</a></div><div class="nav-item"><a href="/blog/sources/index.html" class="nav-link">资源</a></div><div class="nav-item"><a href="https://github.com/theniceangel" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading"><span>软件素养</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/code/software/uml-class-design.html" class="sidebar-link">UML 之类图</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>数据结构</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/code/data-structure/binary-tree.html" class="sidebar-link">二叉树</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Vue</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/code/vue/vuex.html" class="sidebar-link">vuex</a></li><li><a href="/blog/code/vue/vue-router.html" class="sidebar-link">Vue-Router</a></li><li><a href="/blog/code/vue/vue-array-optimize.html" class="sidebar-link">Vue 性能优化之深挖数组</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>源码篇</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/code/sources/default.html" class="sidebar-link">webpack 学习篇</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>异步编程</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/code/async/co.html" class="sidebar-link">co 库</a></li><li><a href="/blog/code/async/promise.html" class="sidebar-link">怎样实现 Promise</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading open"><span>webpack 源码之准备篇</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/code/webpack/source-code-prepare/tapable-0.2.html" class="sidebar-link">tapable(0.2.8 版本)</a></li><li><a href="/blog/code/webpack/source-code-prepare/tapable-2.0.html" class="active sidebar-link">tapable (2.0.0-beta 版本)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/code/webpack/source-code-prepare/tapable-2.0.html#hook-类" class="sidebar-link">Hook 类</a></li><li class="sidebar-sub-header"><a href="/blog/code/webpack/source-code-prepare/tapable-2.0.html#hook-helper-与-tapable-类" class="sidebar-link">Hook Helper 与 Tapable 类</a></li><li class="sidebar-sub-header"><a href="/blog/code/webpack/source-code-prepare/tapable-2.0.html#简单上手" class="sidebar-link">简单上手</a></li><li class="sidebar-sub-header"><a href="/blog/code/webpack/source-code-prepare/tapable-2.0.html#探索原理" class="sidebar-link">探索原理</a></li><li class="sidebar-sub-header"><a href="/blog/code/webpack/source-code-prepare/tapable-2.0.html#阻力与寻找解决办法。" class="sidebar-link">阻力与寻找解决办法。</a></li><li class="sidebar-sub-header"><a href="/blog/code/webpack/source-code-prepare/tapable-2.0.html#同步钩子案例大全" class="sidebar-link">同步钩子案例大全</a></li><li class="sidebar-sub-header"><a href="/blog/code/webpack/source-code-prepare/tapable-2.0.html#异步钩子案例大全" class="sidebar-link">异步钩子案例大全</a></li><li class="sidebar-sub-header"><a href="/blog/code/webpack/source-code-prepare/tapable-2.0.html#同异步钩子类的总结" class="sidebar-link">同异步钩子类的总结</a></li><li class="sidebar-sub-header"><a href="/blog/code/webpack/source-code-prepare/tapable-2.0.html#tapable" class="sidebar-link">Tapable</a></li><li class="sidebar-sub-header"><a href="/blog/code/webpack/source-code-prepare/tapable-2.0.html#所获" class="sidebar-link">所获</a></li></ul></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>webpack 源码之分析篇</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/code/webpack/source-code/init.html" class="sidebar-link">核心概念</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>webpack 源码之 Class 篇</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/code/webpack/source-code-class/dependency.html" class="sidebar-link">Dependency 及其衍生类</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>杂项</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/code/others/minipack.html" class="sidebar-link">手写 mini 打包工具</a></li><li><a href="/blog/code/others/flatten-array.html" class="sidebar-link">扁平化多维数组的不同实现方式</a></li><li><a href="/blog/code/others/regex.html" class="sidebar-link">正则收集</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="tapable-2-0-0-beta-版本"><a href="#tapable-2-0-0-beta-版本" aria-hidden="true" class="header-anchor">#</a> tapable (2.0.0-beta 版本)</h1> <p>之前看了 tapable 0.2 版本的源码，看起来很好懂，但是也存在一些缺点，就是无法明确地知道 plugin 是属于同步，还是异步，而且关于 async 的插件都是采用递归的方式，有点&quot;杂乱无章的感觉&quot;，</p> <p>但是 tapable 2.0.0-beta 版本的重构，犹如艺术品一般，让人惊艳。源码内部采用 getter 惰性加载与缓存的方式，以及利用 new Function 去消除递归调用。</p> <p>消除递归调用的方式就是在第一次调用 call 的时候，通过字符串拼接可执行的字符串代码（源码内部称之为 compile），通过 new Function 来生成 fn，并且缓存下来。这样的作用就是将递归代码非递归化，能减少内存的消耗。</p> <p>先来张图，直观感受下 Tapable 的架构，为什么称之为艺术。</p> <img src="/blog/assets/tapable-2.0.0.list.png" width="100%" alt="tapable-2.0.0.list"> <p>可以看出 Tabable 重构之后多了一个 Hook 的概念，有同步钩子，异步串行钩子，异步并行钩子等。每种钩子都是一个类，它们都是继承于 Hook 基类。阐述下各种 Hook 类的作用。</p> <h2 id="hook-类"><a href="#hook-类" aria-hidden="true" class="header-anchor">#</a> Hook 类</h2> <table><thead><tr><th>名称</th> <th>钩入的方式</th> <th>作用</th></tr></thead> <tbody><tr><td>Hook</td> <td><code>tap</code>， <code>tapAsync</code>，<code>tapPromise</code></td> <td>钩子基类</td></tr> <tr><td>SyncHook</td> <td><code>tap</code></td> <td>同步钩子</td></tr> <tr><td>SyncBailHook</td> <td><code>tap</code></td> <td>同步钩子，只要执行的 handler 有返回值，剩余 handler 不执行</td></tr> <tr><td>SyncLoopHook</td> <td><code>tap</code></td> <td>同步钩子，只要执行的 handler 有返回值，一直循环执行此 handler</td></tr> <tr><td>SyncWaterfallHook</td> <td><code>tap</code></td> <td>同步钩子，上一个 handler 的返回值作为下一个 handler 的输入值</td></tr> <tr><td>AsyncParallelBailHook</td> <td><code>tap</code>， <code>tapAsync</code>，<code>tapPromise</code></td> <td>异步钩子，handler 并行触发，但是跟 handler 内部调用回调函数的逻辑有关</td></tr> <tr><td>AsyncParallelHook</td> <td><code>tap</code>， <code>tapAsync</code>，<code>tapPromise</code></td> <td>异步钩子，handler 并行触发</td></tr> <tr><td>AsyncSeriesBailHook</td> <td><code>tap</code>， <code>tapAsync</code>，<code>tapPromise</code></td> <td>异步钩子，handler 串行触发，但是跟 handler 内部调用回调函数的逻辑有关</td></tr> <tr><td>AsyncSeriesHook</td> <td><code>tap</code>， <code>tapAsync</code>，<code>tapPromise</code></td> <td>异步钩子，handler 串行触发</td></tr> <tr><td>AsyncSeriesLoopHook</td> <td><code>tap</code>， <code>tapAsync</code>，<code>tapPromise</code></td> <td>异步钩子，可以触发 handler 循环调用</td></tr> <tr><td>AsyncSeriesWaterfallHook</td> <td><code>tap</code>， <code>tapAsync</code>，<code>tapPromise</code></td> <td>异步钩子，上一个 handler 可以根据内部的回调函数传值给下一个 handler</td></tr></tbody></table> <h2 id="hook-helper-与-tapable-类"><a href="#hook-helper-与-tapable-类" aria-hidden="true" class="header-anchor">#</a> Hook Helper 与 Tapable 类</h2> <table><thead><tr><th>名称</th> <th>作用</th></tr></thead> <tbody><tr><td>HookCodeFactory</td> <td>编译生成可执行 fn 的工厂类</td></tr> <tr><td>HookMap</td> <td>Map 结构，存储多个 Hook 实例</td></tr> <tr><td>MultiHook</td> <td>组合多个 Hook 实例</td></tr> <tr><td>Tapable</td> <td>向前兼容老版本，实例必须拥有 hooks 属性</td></tr></tbody></table> <h2 id="简单上手"><a href="#简单上手" aria-hidden="true" class="header-anchor">#</a> 简单上手</h2> <p>tapable 2.0.0-beta 版本的使用跟之前分析的 0.2.8 版本完全不同，但是实现的功能，以及原理是一致的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> SyncHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>

<span class="token comment">// 实例化 SyncHook</span>
<span class="token keyword">const</span> sh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'arg1'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">// 通过 tap 注册 handler</span>
sh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>arg1<span class="token punctuation">,</span> arg2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arg1<span class="token punctuation">,</span> arg2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token string">'2'</span><span class="token punctuation">,</span>
  before<span class="token punctuation">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>arg1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arg1<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token string">'3'</span><span class="token punctuation">,</span>
  stage<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>arg1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arg1<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 通过 call 执行 handler</span>
sh<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">,</span> <span class="token string">'tapable-2.0.0'</span><span class="token punctuation">)</span>

<span class="token comment">// 打印顺序如下</span>
tapable<span class="token punctuation">,</span> <span class="token number">3</span>
tapable<span class="token punctuation">,</span> <span class="token number">2</span>
tapable<span class="token punctuation">,</span> undefined<span class="token punctuation">,</span> <span class="token number">1</span>
</code></pre></div><p>如上所述，实例化 SyncHook 的时候接收字符串数组。它的长度会影响你通过 call 方法调用 handler 时入参个数。就像例子所示，调用 call 方法传入的是两个参数，实际上 handler 只能接收到一个参数，因为你在 new SyncHook 的时候传入的字符串数组长度是1。SyncHook 对象是通过 tap 方法去注册 handler的，第一个参数必须是字符串或者对象，其实即使是字符串，也会在内部转成对象，变成如下结构：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">interface</span> <span class="token class-name">Tap</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> string<span class="token punctuation">,</span> <span class="token comment">// 标记每个 handler，必须有</span>
  before<span class="token punctuation">:</span> string <span class="token operator">|</span> array<span class="token punctuation">,</span> <span class="token comment">// 插入到指定的 handler 之前</span>
	type<span class="token punctuation">:</span> string<span class="token punctuation">,</span> <span class="token comment">// 类型：'sync', 'async', 'promise'</span>
	fn<span class="token punctuation">:</span> Function<span class="token punctuation">,</span> <span class="token comment">// handler</span>
	stage<span class="token punctuation">:</span> number<span class="token punctuation">,</span> <span class="token comment">// handler 顺序的优先级，默认为 0，越小的排在越前面执行</span>
	context<span class="token punctuation">:</span> boolean <span class="token comment">// 内部是否维护 context 对象，这样在不同的 handler 就能共享这个对象</span>
<span class="token punctuation">}</span>
</code></pre></div><p>因为我 name 为 2 的 handler 注册的时候，是传了一个对象，它的 before 属性为 1，说明这个 handler 要插到 name 为 1 的 handler 之前执行，因此打印的顺序在第二位，但是又因为 name 为 3 的 handler 注册的时候，stage 属性为 -1，比其他的 handler 的 stage 要小，所以它会被移到最前面执行。</p> <h2 id="探索原理"><a href="#探索原理" aria-hidden="true" class="header-anchor">#</a> 探索原理</h2> <p>那么既然我们从 SyncHook 这个最简单的钩子类入手，也知道了如何使用，那么我们从源码的角度来感受下 Tapable 重构版犹如艺术版的架构设计吧。找到入口 <code>tapable/index.js</code></p> <div class="language- extra-class"><pre class="language-text"><code>exports.__esModule = true;
exports.Tapable = require(&quot;./Tapable&quot;);
exports.SyncHook = require(&quot;./SyncHook&quot;);
exports.SyncBailHook = require(&quot;./SyncBailHook&quot;);
exports.SyncWaterfallHook = require(&quot;./SyncWaterfallHook&quot;);
exports.SyncLoopHook = require(&quot;./SyncLoopHook&quot;);
exports.AsyncParallelHook = require(&quot;./AsyncParallelHook&quot;);
exports.AsyncParallelBailHook = require(&quot;./AsyncParallelBailHook&quot;);
exports.AsyncSeriesHook = require(&quot;./AsyncSeriesHook&quot;);
exports.AsyncSeriesBailHook = require(&quot;./AsyncSeriesBailHook&quot;);
exports.AsyncSeriesWaterfallHook = require(&quot;./AsyncSeriesWaterfallHook&quot;);
exports.HookMap = require(&quot;./HookMap&quot;);
exports.MultiHook = require(&quot;./MultiHook&quot;);
</code></pre></div><p>各种钩子类以及钩子辅助类都挂载在对应的属性上。我们先来看 <code>SyncHook</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Hook <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./Hook&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> HookCodeFactory <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./HookCodeFactory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">SyncHookCodeFactory</span> <span class="token keyword">extends</span> <span class="token class-name">HookCodeFactory</span> <span class="token punctuation">{</span>
	<span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onError<span class="token punctuation">,</span> onResult<span class="token punctuation">,</span> onDone<span class="token punctuation">,</span> rethrowIfPossible <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callTapsSeries</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			onError<span class="token punctuation">:</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> err<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">onError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">,</span>
			onDone<span class="token punctuation">,</span>
			rethrowIfPossible
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHookCodeFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">SyncHook</span> <span class="token keyword">extends</span> <span class="token class-name">Hook</span> <span class="token punctuation">{</span>
	<span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;tapAsync is not supported on a SyncHook&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;tapPromise is not supported on a SyncHook&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">compile</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		factory<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> factory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> SyncHook<span class="token punctuation">;</span>
</code></pre></div><p>可以看出，SyncHook 是继承于父类 Hook，并且原型上重写了 tapAsync、tapPromise、compile 三个方法，也就是 SyncHook 不支持通过 tapAsync 与 tapPromise 来注册 handler 的，因为它内部的逻辑是不支持异步的。compile 方法是用来编译生成对应的 fn，而调用 call 方法，其实就是执行了编译生成的 fn。这个是后话，我们先来看下 Hook 类的实现，所有的钩子都是继承于 Hook 基类。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;util&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> deprecateContext <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">deprecate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token string">&quot;Hook.context is deprecated and will be removed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Hook</span> <span class="token punctuation">{</span>
	<span class="token function">constructor</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// args 必须是数组</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_args <span class="token operator">=</span> args<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>taps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存放每次执行 tap 方法的生成的 options 对象</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//存放拦截器</span>
    <span class="token comment">/**
     *  以下三种方法都是惰性加载，再执行一次之后，会缓存编译的 fn，
     *  只有在加入新 handler 的情况下，才会重新编译，缓存编译生成的新 fn
     *  而 fn 其实函数体内将之前版本递归部分都磨平了，这样会减少内存的消耗。
     **/</span>
    <span class="token comment">// 提供 call 方法，执行 sync handler</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>call <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_call<span class="token punctuation">;</span>
    <span class="token comment">// 提供 promise 方法，执行 promise handler</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>promise <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_promise<span class="token punctuation">;</span>
    <span class="token comment">// 提供 callAsync 方法，执行 async handler</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>callAsync <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_callAsync<span class="token punctuation">;</span>
    <span class="token comment">// 会在编译的 setup 期间过滤 this.taps 得到所有的 handler 组成的数组</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_x <span class="token operator">=</span> undefined<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

  <span class="token comment">// 所有子类都必须重写编译方法，因为每个 Hook 子类都有自己的 compile rules。</span>
	<span class="token function">compile</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Abstract: should be overriden&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">_createCall</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			taps<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">,</span>
			interceptors<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">,</span>
			args<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_args<span class="token punctuation">,</span>
			type<span class="token punctuation">:</span> type
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

  <span class="token comment">//  注册 'sync' fn</span>
	<span class="token function">tap</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> options <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> options <span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">!==</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">||</span> options <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
				<span class="token string">&quot;Invalid arguments to tap(options: Object, fn: function)&quot;</span>
			<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options<span class="token punctuation">.</span>name <span class="token operator">!==</span> <span class="token string">&quot;string&quot;</span> <span class="token operator">||</span> options<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Missing name for tap&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options<span class="token punctuation">.</span>context <span class="token operator">!==</span> <span class="token string">&quot;undefined&quot;</span><span class="token punctuation">)</span> <span class="token function">deprecateContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">&quot;sync&quot;</span><span class="token punctuation">,</span> fn<span class="token punctuation">:</span> fn <span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_runRegisterInterceptors</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_insert</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">//  注册 'async' fn</span>
	<span class="token function">tapAsync</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> options <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> options <span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">!==</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">||</span> options <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
				<span class="token string">&quot;Invalid arguments to tapAsync(options: Object, fn: function)&quot;</span>
			<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options<span class="token punctuation">.</span>name <span class="token operator">!==</span> <span class="token string">&quot;string&quot;</span> <span class="token operator">||</span> options<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Missing name for tapAsync&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options<span class="token punctuation">.</span>context <span class="token operator">!==</span> <span class="token string">&quot;undefined&quot;</span><span class="token punctuation">)</span> <span class="token function">deprecateContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">&quot;async&quot;</span><span class="token punctuation">,</span> fn<span class="token punctuation">:</span> fn <span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_runRegisterInterceptors</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_insert</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

  <span class="token comment">//  注册 'promise' fn</span>
	<span class="token function">tapPromise</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> options <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> options <span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">!==</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">||</span> options <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
				<span class="token string">&quot;Invalid arguments to tapPromise(options: Object, fn: function)&quot;</span>
			<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options<span class="token punctuation">.</span>name <span class="token operator">!==</span> <span class="token string">&quot;string&quot;</span> <span class="token operator">||</span> options<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Missing name for tapPromise&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options<span class="token punctuation">.</span>context <span class="token operator">!==</span> <span class="token string">&quot;undefined&quot;</span><span class="token punctuation">)</span> <span class="token function">deprecateContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">&quot;promise&quot;</span><span class="token punctuation">,</span> fn<span class="token punctuation">:</span> fn <span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_runRegisterInterceptors</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_insert</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

  <span class="token comment">// 每次执行 tap 的时候，传入的 options 都要经过 interceptor.register 函数的逻辑。</span>
	<span class="token function">_runRegisterInterceptors</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> interceptor <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>interceptor<span class="token punctuation">.</span>register<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">const</span> newOptions <span class="token operator">=</span> interceptor<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>newOptions <span class="token operator">!==</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					options <span class="token operator">=</span> newOptions<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> options<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">withOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> <span class="token function-variable function">mergeOptions</span> <span class="token operator">=</span> opt <span class="token operator">=&gt;</span>
			Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token keyword">typeof</span> opt <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span> <span class="token operator">?</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> opt <span class="token punctuation">}</span> <span class="token punctuation">:</span> opt<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Prevent creating endless prototype chains</span>
		options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_withOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> base <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_withOptionsBase <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> newHook <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>

		newHook<span class="token punctuation">.</span><span class="token function-variable function">tap</span> <span class="token operator">=</span> <span class="token punctuation">(</span>opt<span class="token punctuation">,</span> fn<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> base<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token function">mergeOptions</span><span class="token punctuation">(</span>opt<span class="token punctuation">)</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
		newHook<span class="token punctuation">.</span><span class="token function-variable function">tapAsync</span> <span class="token operator">=</span> <span class="token punctuation">(</span>opt<span class="token punctuation">,</span> fn<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> base<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token function">mergeOptions</span><span class="token punctuation">(</span>opt<span class="token punctuation">)</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
		newHook<span class="token punctuation">.</span><span class="token function-variable function">tapPromise</span> <span class="token operator">=</span> <span class="token punctuation">(</span>opt<span class="token punctuation">,</span> fn<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> base<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token function">mergeOptions</span><span class="token punctuation">(</span>opt<span class="token punctuation">)</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
		newHook<span class="token punctuation">.</span>_withOptions <span class="token operator">=</span> options<span class="token punctuation">;</span>
		newHook<span class="token punctuation">.</span>_withOptionsBase <span class="token operator">=</span> base<span class="token punctuation">;</span>
		<span class="token keyword">return</span> newHook<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">isUsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

  <span class="token comment">// 注册拦截器</span>
	<span class="token function">intercept</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetCompilation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> interceptor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>interceptor<span class="token punctuation">.</span>register<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> interceptor<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

  <span class="token comment">// 每次注册新 handler，要重新编译</span>
	<span class="token function">_resetCompilation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>call <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_call<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>callAsync <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_callAsync<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>promise <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_promise<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 插入 tap 对象，可能根据 before，stage 属性，调整 handler 的执行顺序</span>
	<span class="token function">_insert</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetCompilation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">let</span> before<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> item<span class="token punctuation">.</span>before <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			before <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span>item<span class="token punctuation">.</span>before<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>before<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			before <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>before<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">let</span> stage <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> item<span class="token punctuation">.</span>stage <span class="token operator">===</span> <span class="token string">&quot;number&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			stage <span class="token operator">=</span> item<span class="token punctuation">.</span>stage<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token comment">// 根据 before，stage 属性，调整 handler 的执行顺序</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			i<span class="token operator">--</span><span class="token punctuation">;</span>
			<span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span>
			<span class="token keyword">const</span> xStage <span class="token operator">=</span> x<span class="token punctuation">.</span>stage <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>before<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>before<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					before<span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">continue</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>before<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">continue</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>xStage <span class="token operator">&gt;</span> stage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			i<span class="token operator">++</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> item<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createCompileDelegate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">lazyCompileHook</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 重新赋值 this.call, this.promise, this.callAsync</span>
    <span class="token comment">// 因为第一个调用 call 的时候，会走到 _createCall 去 compile，生成 fn</span>
    <span class="token comment">// 但是第二次调用 call 的时候，fn 已经赋值给了 this.call 了，不需要走到 compile 的逻辑了。</span>
		<span class="token keyword">this</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createCall</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span>Hook<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token punctuation">{</span>
	_call<span class="token punctuation">:</span> <span class="token punctuation">{</span>
		value<span class="token punctuation">:</span> <span class="token function">createCompileDelegate</span><span class="token punctuation">(</span><span class="token string">&quot;call&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sync&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
		writable<span class="token punctuation">:</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	_promise<span class="token punctuation">:</span> <span class="token punctuation">{</span>
		value<span class="token punctuation">:</span> <span class="token function">createCompileDelegate</span><span class="token punctuation">(</span><span class="token string">&quot;promise&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;promise&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
		writable<span class="token punctuation">:</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	_callAsync<span class="token punctuation">:</span> <span class="token punctuation">{</span>
		value<span class="token punctuation">:</span> <span class="token function">createCompileDelegate</span><span class="token punctuation">(</span><span class="token string">&quot;callAsync&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;async&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
		writable<span class="token punctuation">:</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Hook<span class="token punctuation">;</span>
</code></pre></div><p>可以看到，Hook 提供了 tap、tapAsync、tapPromise 来注册 handler，通过了 call、callAsync、promise 三种方式来调用 handler，同时内部还对这三种调用方式做了惰性求值，并且会缓存编译结果直到注入了新 handler。</p> <p>分析完 Hook 类的大致功能，我们再回到 SyncHook 类。发现 compile 方法里面 new SyncHookCodeFactory。从字面上的理解就是生成同步钩子代码的工厂类，它继承于 HookCodeFactory 类。那么分析下 <code>HookCodeFactory.js</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/*
	MIT License http://www.opensource.org/licenses/mit-license.php
	Author Tobias Koppers @sokra
*/</span>
<span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">HookCodeFactory</span> <span class="token punctuation">{</span>
	<span class="token function">constructor</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>config <span class="token operator">=</span> config<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> undefined<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_args <span class="token operator">=</span> undefined<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">create</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">let</span> fn<span class="token punctuation">;</span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token string">&quot;sync&quot;</span><span class="token punctuation">:</span>
				fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					<span class="token string">'&quot;use strict&quot;;\n'</span> <span class="token operator">+</span>
						<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
						<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
							onError<span class="token punctuation">:</span> err <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token string">`throw </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;\n`</span></span><span class="token punctuation">,</span>
							onResult<span class="token punctuation">:</span> result <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token string">`return </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;\n`</span></span><span class="token punctuation">,</span>
							onDone<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
							rethrowIfPossible<span class="token punctuation">:</span> <span class="token boolean">true</span>
						<span class="token punctuation">}</span><span class="token punctuation">)</span>
				<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token string">&quot;async&quot;</span><span class="token punctuation">:</span>
				fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
						after<span class="token punctuation">:</span> <span class="token string">&quot;_callback&quot;</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					<span class="token string">'&quot;use strict&quot;;\n'</span> <span class="token operator">+</span>
						<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
						<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
							onError<span class="token punctuation">:</span> err <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token string">`_callback(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);\n`</span></span><span class="token punctuation">,</span>
							onResult<span class="token punctuation">:</span> result <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token string">`_callback(null, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);\n`</span></span><span class="token punctuation">,</span>
							onDone<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;_callback();\n&quot;</span>
						<span class="token punctuation">}</span><span class="token punctuation">)</span>
				<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token string">&quot;promise&quot;</span><span class="token punctuation">:</span>
				<span class="token operator">...</span><span class="token operator">...</span>
				fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">deinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> fn<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">setup</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		instance<span class="token punctuation">.</span>_x <span class="token operator">=</span> options<span class="token punctuation">.</span>taps<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>t <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_args <span class="token operator">=</span> options<span class="token punctuation">.</span>args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">deinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> undefined<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_args <span class="token operator">=</span> undefined<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">let</span> code <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
		<span class="token operator">...</span><span class="token operator">...</span>
		<span class="token keyword">return</span> code<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">needContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> tap <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>taps<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tap<span class="token punctuation">.</span>context<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">callTap</span><span class="token punctuation">(</span>tapIndex<span class="token punctuation">,</span> <span class="token punctuation">{</span> onError<span class="token punctuation">,</span> onResult<span class="token punctuation">,</span> onDone<span class="token punctuation">,</span> rethrowIfPossible <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token operator">...</span><span class="token operator">...</span>
		<span class="token keyword">return</span> code<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">callTapsSeries</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onError<span class="token punctuation">,</span> onResult<span class="token punctuation">,</span> onDone<span class="token punctuation">,</span> rethrowIfPossible <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token operator">...</span>
	<span class="token punctuation">}</span>

	<span class="token function">callTapsLooping</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onError<span class="token punctuation">,</span> onDone<span class="token punctuation">,</span> rethrowIfPossible <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token operator">...</span><span class="token operator">...</span>
	<span class="token punctuation">}</span>

	<span class="token function">callTapsParallel</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
		onError<span class="token punctuation">,</span>
		onResult<span class="token punctuation">,</span>
		onDone<span class="token punctuation">,</span>
		rethrowIfPossible<span class="token punctuation">,</span>
		<span class="token function-variable function">onTap</span> <span class="token operator">=</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> run<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token operator">...</span><span class="token operator">...</span>
		<span class="token keyword">return</span> code<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">{</span> before<span class="token punctuation">,</span> after <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token operator">...</span><span class="token operator">...</span>
	<span class="token punctuation">}</span>

  <span class="token operator">...</span><span class="token operator">...</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> HookCodeFactory<span class="token punctuation">;</span>

</code></pre></div><p>HookCodeFactory 的原型上有很多方法，但是千万不要慌，也不要畏惧。如果看不懂代码，我们可以一步步 debugger 去调试。</p> <p>SyncHook 在执行 compile 的时候会调用 HookCodeFactory 的 setup、create 方法，我们先来看下这两个方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setup</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 过滤出传入的 handler</span>
  instance<span class="token punctuation">.</span>_x <span class="token operator">=</span> options<span class="token punctuation">.</span>taps<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>t <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_args <span class="token operator">=</span> options<span class="token punctuation">.</span>args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">deinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> undefined<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_args <span class="token operator">=</span> undefined<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">create</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取调用方 new SyncHook(options)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> fn<span class="token punctuation">;</span>
  <span class="token comment">// 判断 handler 的类型，通过 new Function 将字符串变成 fn</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">&quot;sync&quot;</span><span class="token punctuation">:</span>
      fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'&quot;use strict&quot;;\n'</span> <span class="token operator">+</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            onError<span class="token punctuation">:</span> err <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token string">`throw </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;\n`</span></span><span class="token punctuation">,</span>
            onResult<span class="token punctuation">:</span> result <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token string">`return </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;\n`</span></span><span class="token punctuation">,</span>
            onDone<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
            rethrowIfPossible<span class="token punctuation">:</span> <span class="token boolean">true</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">&quot;async&quot;</span><span class="token punctuation">:</span>
      fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          after<span class="token punctuation">:</span> <span class="token string">&quot;_callback&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'&quot;use strict&quot;;\n'</span> <span class="token operator">+</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            onError<span class="token punctuation">:</span> err <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token string">`_callback(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);\n`</span></span><span class="token punctuation">,</span>
            onResult<span class="token punctuation">:</span> result <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token string">`_callback(null, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);\n`</span></span><span class="token punctuation">,</span>
            onDone<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;_callback();\n&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">&quot;promise&quot;</span><span class="token punctuation">:</span>
      <span class="token operator">...</span><span class="token operator">...</span>
      fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 重置参数，因为 SyncHook 类保存的是一份 HookCodeFactory 类的实例，所以每次编译完，为了防止影响 其他SyncHook 实例。</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">deinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 返回编译生成的函数</span>
  <span class="token keyword">return</span> fn<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从执行的逻辑来看，就是先从 taps 里面过滤出 handler，然后根据类型来生成对应的 fn。所以我们在调用 call、callAsync、promise 的时候，执行的就是编译生成的 fn，并且把参数传入。</p> <p>上面的例子是用到的 SyncHook，只会走到 <code>case &quot;sync&quot;</code> 的逻辑，我们<strong>重点分析</strong>如何生成 fn 的，其余的也是依葫芦画瓢。</p> <div class="language-js extra-class"><pre class="language-js"><code>fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">'&quot;use strict&quot;;\n'</span> <span class="token operator">+</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      onError<span class="token punctuation">:</span> err <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token string">`throw </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;\n`</span></span><span class="token punctuation">,</span>
      onResult<span class="token punctuation">:</span> result <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token string">`return </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;\n`</span></span><span class="token punctuation">,</span>
      onDone<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
      rethrowIfPossible<span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>那我们从下面三个步骤来看：</p> <ul><li><p><strong>生成 fn 的形参</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">{</span> before<span class="token punctuation">,</span> after <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> allArgs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_args<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>before<span class="token punctuation">)</span> allArgs <span class="token operator">=</span> <span class="token punctuation">[</span>before<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>allArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>after<span class="token punctuation">)</span> allArgs <span class="token operator">=</span> allArgs<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>after<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>allArgs<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> allArgs<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;, &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>根据实例化 SyncHook 传入的参数以逗号拼接形参字符串。支持 before 与 after 属性，能够在字符串的头部或者尾部插入对应的属性值字符串。比如 new SyncHook(['arg1', 'arg2'])，那么经过 this.args 处理后，就变成 &quot;arg1, arg2&quot;。再通过 fn = new Function(&quot;arg1, arg2&quot;) 之后，就变成 fn 接收 arg1 与 arg2两个形参了。假如你在使用 call 方法的时候传入三个参数，那么第三个参数就获取不到了，因为 fn 只支持两个参数。</p></li> <li><p><strong>生成 fn 函数体的头部代码字符串</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> code <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
  <span class="token comment">// tap 的时候传入了 {context: true}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">needContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    code <span class="token operator">+=</span> <span class="token string">&quot;var _context = {};\n&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    code <span class="token operator">+=</span> <span class="token string">&quot;var _context;\n&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  code <span class="token operator">+=</span> <span class="token string">&quot;var _x = this._x;\n&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    code <span class="token operator">+=</span> <span class="token string">&quot;var _taps = this.taps;\n&quot;</span><span class="token punctuation">;</span>
    code <span class="token operator">+=</span> <span class="token string">&quot;var _interceptors = this.interceptors;\n&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> interceptor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>interceptors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>interceptor<span class="token punctuation">.</span>call<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      code <span class="token operator">+=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getInterceptor</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.call(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        before<span class="token punctuation">:</span> interceptor<span class="token punctuation">.</span>context <span class="token operator">?</span> <span class="token string">&quot;_context&quot;</span> <span class="token punctuation">:</span> undefined
      <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)});\n`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> code<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">needContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> tap <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>taps<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tap<span class="token punctuation">.</span>context<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">getInterceptor</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`_interceptors[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>idx<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>header 函数主要是生成头部的一些参数，可以看到如果通过 tap、tapPromise、tapAsync 注册 handler的时候传入了 <code>context: true</code>，那么会生成 _context 对象，并且会将 _context 传入每一个 handler，因为这是个对象引用，所以对于每个 handler 来说，其实是共享了一份 _context 对象。同时 Hook 是支持通过 intercept 方法注册拦截器的，该方法接收一个对象作为入参，该对象都会保存在钩子实例的 interceptors 数组。数据结构如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">interface</span> <span class="token class-name">HookInterceptor</span> <span class="token punctuation">{</span>
  call<span class="token punctuation">:</span> <span class="token punctuation">(</span>context<span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">,</span> <span class="token comment">// 还未开始执行 handler 之前执行</span>
  loop<span class="token punctuation">:</span> <span class="token punctuation">(</span>context<span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
  tap<span class="token punctuation">:</span> <span class="token punctuation">(</span>context<span class="token operator">?</span><span class="token punctuation">,</span> tap<span class="token punctuation">:</span> Tap<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">,</span> <span class="token comment">// 插入一个 handler</span>
  register<span class="token punctuation">:</span> <span class="token punctuation">(</span>tap<span class="token punctuation">:</span> Tap<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Tap<span class="token punctuation">,</span> <span class="token comment">// 改变 tap 对象</span>
  context<span class="token punctuation">:</span> boolean
<span class="token punctuation">}</span>
</code></pre></div><p>从接口来看，我们可以通过 intercept 方法来插入自己的逻辑，不仅可以注册 handler 还可以改变 tap 对象，这样使得钩子变得更灵活，更有弹性。</p></li> <li><p><strong>生成 fn 函数体的中间执行代码的字符串</strong></p> <p>看完了 header 的逻辑，我们再来看 content 的逻辑，因为 content 对于每种钩子的代码生成都不一样，所以是在对应的钩子生成的工厂类上做了覆盖，那么对于 SyncHook 而言，content 是在 SyncHookCodeFactory 这个工厂类重写了 content 方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">SyncHookCodeFactory</span> <span class="token keyword">extends</span> <span class="token class-name">HookCodeFactory</span> <span class="token punctuation">{</span>
  <span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onError<span class="token punctuation">,</span> onResult<span class="token punctuation">,</span> onDone<span class="token punctuation">,</span> rethrowIfPossible <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callTapsSeries</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      onError<span class="token punctuation">:</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> err<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">onError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">,</span>
      onDone<span class="token punctuation">,</span>
      rethrowIfPossible
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到 SyncHookCodeFactory 这个类的 content 方法是接收一个对象，并且内部又调用了 HookCodeFactory 类上的 callTapsSeries 方法，同时将 onError、onDone、rethrowIfPossible 传入了。我们看下 <code>callTapsSeries</code> 的定义。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">callTapsSeries</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onError<span class="token punctuation">,</span> onResult<span class="token punctuation">,</span> onDone<span class="token punctuation">,</span> rethrowIfPossible <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>taps<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">onDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> firstAsync <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>taps<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span>t <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token string">&quot;sync&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">next</span> <span class="token operator">=</span> i <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>taps<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">onDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token function-variable function">done</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">next</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">doneBreak</span> <span class="token operator">=</span> skipDone <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>skipDone<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">onDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callTap</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      onError<span class="token punctuation">:</span> error <span class="token operator">=&gt;</span> <span class="token function">onError</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> error<span class="token punctuation">,</span> done<span class="token punctuation">,</span> doneBreak<span class="token punctuation">)</span><span class="token punctuation">,</span>
      onResult<span class="token punctuation">:</span>
        onResult <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>result <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">onResult</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> result<span class="token punctuation">,</span> done<span class="token punctuation">,</span> doneBreak<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      onDone<span class="token punctuation">:</span>
        <span class="token operator">!</span>onResult <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      rethrowIfPossible<span class="token punctuation">:</span>
        rethrowIfPossible <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>firstAsync <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> i <span class="token operator">&lt;</span> firstAsync<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从上面可以看出函数内部维护了一个 next 函数，next 函数内部会调用 callTap，而 callTap 内部会在合适的时机调用 done，那么又会走到 next 函数，那么这样就形成了自执行的机制，而函数退出的条件就是遍历了所有的 this.options.taps 之后，这个数据是维护了我们通过 tap、tapPromise、tapAsync 注册 handler 的信息。</p></li></ul> <h2 id="阻力与寻找解决办法。"><a href="#阻力与寻找解决办法。" aria-hidden="true" class="header-anchor">#</a> 阻力与寻找解决办法。</h2> <p>从上面剖析 SyncHook 源码的结果来看，尤其是 compile 那块涉及到拼接字符串，通过 new Function 生成 fn。这一块可阅读性比较差，所以我们以具体的 Hook 类的使用场景，来覆盖源码的每个步骤，一步步调试。</p> <h2 id="同步钩子案例大全"><a href="#同步钩子案例大全" aria-hidden="true" class="header-anchor">#</a> 同步钩子案例大全</h2> <p>所有的同步钩子只支持 tap 方法来注册 sync handler。</p> <h3 id="synchook（同步钩子）"><a href="#synchook（同步钩子）" aria-hidden="true" class="header-anchor">#</a> syncHook（同步钩子）</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> SyncHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>

<span class="token comment">// 实例化 SyncHook</span>
<span class="token keyword">const</span> sh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'arg1'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">// 通过 tap 注册 handler</span>
sh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>arg1<span class="token punctuation">,</span> arg2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arg1<span class="token punctuation">,</span> arg2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token string">'2'</span><span class="token punctuation">,</span>
  before<span class="token punctuation">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>arg1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arg1<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token string">'3'</span><span class="token punctuation">,</span>
  stage<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>arg1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arg1<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 通过 call 执行 handler</span>
sh<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">,</span> <span class="token string">'tapable-2.0.0'</span><span class="token punctuation">)</span>

<span class="token comment">// 打印顺序如下</span>
tapable<span class="token punctuation">,</span> <span class="token number">3</span>
tapable<span class="token punctuation">,</span> <span class="token number">2</span>
tapable<span class="token punctuation">,</span> undefined<span class="token punctuation">,</span> <span class="token number">1</span>
</code></pre></div><ol><li><p><strong>tap 的源码分析</strong></p> <ul><li>先校验 options 参数的格式，再走到 _runRegisterInterceptors 方法，这一步是为了执行拦截器的 register 方法，来改变 options。</li> <li>接着走到 _insert 内部，内部根据 before、stage 属性来调整 handler 的顺序，并且将所有的信息保存到 taps 数组里面。</li></ul></li> <li><p><strong>call 的源码分析</strong></p> <ul><li>执行 call，就是执行了原型上的 _call，也就是执行了 createCompileDelegate，这个函数返回的是另外一个 lazyCompileHook 函数，在 lazyCompileHook 函数内部会重新赋值 call 方法，得到编译后的结果。也就是第二次调用 call的时候，其实就是执行 _createCall 方法的返回值。</li> <li>_createCall 内部执行了 compile 方法，这个方法在 SyncHook 的原型上。compile 的内部先执行 SyncHookCodeFactory 上的 setup 方法，然后执行 create 方法。</li> <li>setup 与 create 方法都是在 HookCodeFactory 的原型上，因为 SyncHookCodeFactory 是继承于 HookCodeFactory。</li> <li>setup 内部的逻辑很简单，就是从 taps 数组过滤出传入的 handler。</li> <li>create 内部先初始化 options 参数，这个是在调用 compile 的时候传入的，然后通过字符串拼接执行 new Function 得到 fn，最后执行的也是这个 fn。</li></ul></li></ol> <p>我们一般对 new Function 很陌生，所以很好奇 create 里面到底是生成了什么。可以在 new Function 打个断点，一步步 debugger 一下，最后会发现生成的 fn 是如下的函数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">anonymous</span><span class="token punctuation">(</span>arg1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// header</span>
  <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> _context<span class="token punctuation">;</span>
  <span class="token keyword">var</span> _x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_x<span class="token punctuation">;</span>
  <span class="token comment">// content</span>
  <span class="token keyword">var</span> _fn0 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">_fn0</span><span class="token punctuation">(</span>arg1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> _fn1 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">_fn1</span><span class="token punctuation">(</span>arg1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> _fn2 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">_fn2</span><span class="token punctuation">(</span>arg1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// arg1 参数，其实就是在 new Function 时候调用 this.args 生成的字符串而来的，而 this.args 是由实例化钩子传入的</span>
<span class="token comment">// header 块，this.header 生成的 (HookCodeFactory 原型上)</span>
<span class="token comment">// content 块，this.content 生成的 (这个方法会在对应的钩子工厂类的原型上重写)</span>
</code></pre></div><p>而执行 sh.call('tapable', 'tapable-2.0.0')，其实执行的就是上述的函数，那么这个库的作者处心积虑的这么做的意义何在呢，当然这个例子也看不出很大的作用，只能看到函数体内部没有 for 循环，函数的执行都是扁平的。最大的好处其实在于你看过 Async*Hook 编译出来的 fn，你就知道为啥要这么做了。</p> <h3 id="syncbailhook（同步保险钩子）"><a href="#syncbailhook（同步保险钩子）" aria-hidden="true" class="header-anchor">#</a> SyncBailHook（同步保险钩子）</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> sbh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'arg1'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
sbh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
  context<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> 
  name<span class="token punctuation">:</span> <span class="token string">'1'</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> arg1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> arg1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sbh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token string">'2'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>arg1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 不会执行</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arg1<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

sbh<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>

<span class="token comment">// 打印</span>
<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> tapable<span class="token punctuation">,</span> <span class="token number">1</span>
</code></pre></div><p><strong>编译的 fn 如下</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">anonymous</span><span class="token punctuation">(</span>arg1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> _context <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> _x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_x<span class="token punctuation">;</span>
    <span class="token keyword">var</span> _fn0 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> _result0 <span class="token operator">=</span> <span class="token function">_fn0</span><span class="token punctuation">(</span>_context<span class="token punctuation">,</span> arg1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_result0 <span class="token operator">!==</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> _result0<span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> _fn1 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> _result1 <span class="token operator">=</span> <span class="token function">_fn1</span><span class="token punctuation">(</span>arg1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_result1 <span class="token operator">!==</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> _result1<span class="token punctuation">;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>SyncBailHook 从字面上的意思是同步保险钩子，也就是只要前面的 handler 返回值不是 undefined，下一个 handler 就不会被触发。</p> <h3 id="syncloophook（同步循环钩子）"><a href="#syncloophook（同步循环钩子）" aria-hidden="true" class="header-anchor">#</a> SyncLoopHook（同步循环钩子）</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> slh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncLoopHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 因为 handler 返回值不为 undefined，会一直循环执行</span>
slh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
slh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token number">2</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
slh<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>编译的 fn 如下</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">anonymous</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> _context<span class="token punctuation">;</span>
    <span class="token keyword">var</span> _x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_x<span class="token punctuation">;</span>
    <span class="token keyword">var</span> _loop<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        _loop <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> _fn0 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> _result0 <span class="token operator">=</span> <span class="token function">_fn0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_result0 <span class="token operator">!==</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            _loop <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> _fn1 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> _result1 <span class="token operator">=</span> <span class="token function">_fn1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_result1 <span class="token operator">!==</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                _loop <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_loop<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span> _loop <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>SyncLoopHook 从字面上的意思是同步循环钩子，也就是只要前面的 handler 返回值不是 undefined，那么会一直循环执行。</p> <h3 id="syncwaterfallhook（同步瀑布钩子）"><a href="#syncwaterfallhook（同步瀑布钩子）" aria-hidden="true" class="header-anchor">#</a> SyncWaterfallHook（同步瀑布钩子）</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// SyncWaterfallHook 必须传入一个长度不为 0 的数组</span>
<span class="token keyword">const</span> swfh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncWaterfallHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'arg'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
swfh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
swfh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token number">2</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
swfh<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span>

<span class="token comment">// 打印如下</span>
webpack
<span class="token number">1</span>
</code></pre></div><p><strong>编译的 fn 如下</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">anonymous</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> _context<span class="token punctuation">;</span>
    <span class="token keyword">var</span> _x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_x<span class="token punctuation">;</span>
    <span class="token keyword">var</span> _fn0 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> _result0 <span class="token operator">=</span> <span class="token function">_fn0</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_result0 <span class="token operator">!==</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        arg <span class="token operator">=</span> _result0<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> _fn1 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> _result1 <span class="token operator">=</span> <span class="token function">_fn1</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_result1 <span class="token operator">!==</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        arg <span class="token operator">=</span> _result1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> arg<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>对于 SyncWaterfallHook，前面的 handler 返回值作为下一个 handler 的输入值，并且要求实例化 SyncWaterfallHook 的时候，传入非零长度的数组。call 传入的参数会作为第一个 handler 的入参。</p> <h2 id="异步钩子案例大全"><a href="#异步钩子案例大全" aria-hidden="true" class="header-anchor">#</a> 异步钩子案例大全</h2> <p>所有的异步钩子支持 tap、tapAsync、tapPromise 方法来注册各种类型的 handler，但是不支持 call 方法来触发 handler，只支持 promise、callAsync。</p> <h3 id="asyncparallelbailhook（异步并行保险钩子）"><a href="#asyncparallelbailhook（异步并行保险钩子）" aria-hidden="true" class="header-anchor">#</a> AsyncParallelBailHook（异步并行保险钩子）</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> apbh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncParallelBailHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
apbh<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
apbh<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
apbh<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'callback 执行完成'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 打印如下</span>
<span class="token number">1</span> <span class="token comment">// 3s 后打印的</span>
callback 执行完成
</code></pre></div><p><strong>编译的 fn 如下</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">anonymous</span><span class="token punctuation">(</span>_callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> _context<span class="token punctuation">;</span>
    <span class="token keyword">var</span> _x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_x<span class="token punctuation">;</span>
    <span class="token keyword">var</span> _results <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> _checkDone <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> _results<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> item <span class="token operator">=</span> _results<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>item <span class="token operator">===</span> undefined<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>result <span class="token operator">!==</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">_callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> item<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">_callback</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> _counter <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> _done <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&gt;</span><span class="token punctuation">{</span>
            <span class="token function">_callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_counter <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> _fn0 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">_fn0</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_err0<span class="token punctuation">,</span> _result0<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_err0<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>_counter <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;</span> _results<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>_results<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>_results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
                        error<span class="token punctuation">:</span> _err0
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_checkDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        _counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>_counter <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">_done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>_counter <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;</span> _results<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>_result0 <span class="token operator">!==</span> undefined <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>_results<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>_results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
                        result<span class="token punctuation">:</span> _result0
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_checkDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        _counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>_counter <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">_done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_counter <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&gt;=</span> _results<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>_counter <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">_done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> _fn1 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">_fn1</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_err1<span class="token punctuation">,</span> _result1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&gt;</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>_err1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>_counter <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;</span> _results<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>_results<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>_results<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
                            error<span class="token punctuation">:</span> _err1
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_checkDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            _counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>_counter <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">_done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>_counter <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;</span> _results<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>_result1 <span class="token operator">!==</span> undefined <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>_results<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>_results<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
                            result<span class="token punctuation">:</span> _result1
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_checkDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            _counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>_counter <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">_done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token boolean">false</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>从 AsyncParallelBailHook 来看，每个 handler 的最后一位形参是 next，它是一个函数，用户必须手动执行并且传参，这样 callback 会拿到该参数并且执行。从例子可以看出，callback 的执行是取决于注册的 handler 的顺序，虽然 next(2) 是在 1s 后就执行了，但是还是不会触发 callback，而是 next(1) 触发了 callback。</p> <h3 id="asyncparallelhook（异步并行钩子）"><a href="#asyncparallelhook（异步并行钩子）" aria-hidden="true" class="header-anchor">#</a> AsyncParallelHook（异步并行钩子）</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> apl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncParallelHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

apl<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
apl<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
apl<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'callback 执行完成'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 打印如下</span>
<span class="token number">2</span> <span class="token comment">// 1s 后打印的</span>
callback 执行完成
</code></pre></div><p><strong>编译的 fn 如下</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">anonymous</span><span class="token punctuation">(</span>_callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> _context<span class="token punctuation">;</span>
    <span class="token keyword">var</span> _x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_x<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> _counter <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> _done <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&gt;</span><span class="token punctuation">{</span>
            <span class="token function">_callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_counter <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> _fn0 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">_fn0</span><span class="token punctuation">(</span>_err0 <span class="token operator">=</span> <span class="token operator">&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_err0<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>_counter <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">_callback</span><span class="token punctuation">(</span>_err0<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    _counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>_counter <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">_done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_counter <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> _fn1 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">_fn1</span><span class="token punctuation">(</span>_err1 <span class="token operator">=</span> <span class="token operator">&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_err1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>_counter <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">_callback</span><span class="token punctuation">(</span>_err1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    _counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>_counter <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">_done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token boolean">false</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>从 AsyncParallelHook 来看，每个 handler 的最后一位形参是 next，它是一个函数，用户必须手动执行并且传参，这样 callback 会拿到该参数并且执行。从例子可以看出，callback 的执行是取决执行 next 函数的快慢。</p> <h3 id="asyncseriesbailhook（异步串行保险钩子）"><a href="#asyncseriesbailhook（异步串行保险钩子）" aria-hidden="true" class="header-anchor">#</a> AsyncSeriesBailHook（异步串行保险钩子）</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> asbh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesBailHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

asbh<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
asbh<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
asbh<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 打印如下</span>
<span class="token number">1</span> <span class="token comment">// 3s 后打印的</span>
</code></pre></div><p><strong>编译的 fn 如下</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">anonymous</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_resolve<span class="token punctuation">,</span> _reject<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> _sync <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> _context<span class="token punctuation">;</span>
        <span class="token keyword">var</span> _x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_x<span class="token punctuation">;</span>
        <span class="token keyword">var</span> _fn0 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> _hasResult0 <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> _promise0 <span class="token operator">=</span> <span class="token function">_fn0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_promise0 <span class="token operator">||</span> <span class="token operator">!</span>_promise0<span class="token punctuation">.</span>then<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Tap function (tapPromise) did not return promise (returned '</span> <span class="token operator">+</span> _promise0 <span class="token operator">+</span> <span class="token string">')'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _promise0<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>_result0 <span class="token operator">=</span> <span class="token operator">&gt;</span><span class="token punctuation">{</span>
            _hasResult0 <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_result0 <span class="token operator">!==</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">_resolve</span><span class="token punctuation">(</span>_result0<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">var</span> _fn1 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">var</span> _hasResult1 <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">var</span> _promise1 <span class="token operator">=</span> <span class="token function">_fn1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_promise1 <span class="token operator">||</span> <span class="token operator">!</span>_promise1<span class="token punctuation">.</span>then<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Tap function (tapPromise) did not return promise (returned '</span> <span class="token operator">+</span> _promise1 <span class="token operator">+</span> <span class="token string">')'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                _promise1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>_result1 <span class="token operator">=</span> <span class="token operator">&gt;</span><span class="token punctuation">{</span>
                    _hasResult1 <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>_result1 <span class="token operator">!==</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">_resolve</span><span class="token punctuation">(</span>_result1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token function">_resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                _err1 <span class="token operator">=</span> <span class="token operator">&gt;</span><span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>_hasResult1<span class="token punctuation">)</span> <span class="token keyword">throw</span> _err1<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>_sync<span class="token punctuation">)</span> <span class="token function">_resolve</span><span class="token punctuation">(</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&gt;</span><span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> _err1<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">else</span> <span class="token function">_reject</span><span class="token punctuation">(</span>_err1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        _err0 <span class="token operator">=</span> <span class="token operator">&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_hasResult0<span class="token punctuation">)</span> <span class="token keyword">throw</span> _err0<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_sync<span class="token punctuation">)</span> <span class="token function">_resolve</span><span class="token punctuation">(</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&gt;</span><span class="token punctuation">{</span>
                <span class="token keyword">throw</span> _err0<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token function">_reject</span><span class="token punctuation">(</span>_err0<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _sync <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>我们用 tapPromise 方法做了个测试，handler 必须返回一个 Promise，而且 AsyncSeriesBailHook 钩子的 promise 方法返回的是一个 Promise，then 里面的回调函数的参数与注册的 handler 返回的 Promise 有关。</p> <h3 id="asyncserieshook（异步串行钩子）"><a href="#asyncserieshook（异步串行钩子）" aria-hidden="true" class="header-anchor">#</a> AsyncSeriesHook（异步串行钩子）</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> ash <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

ash<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
ash<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token string">'触发 callback'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
ash<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">callback</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'callback 执行完了'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 打印如下</span>
<span class="token number">1</span>
<span class="token number">2</span>
callback 执行完了
</code></pre></div><p><strong>编译的 fn 如下</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">anonymous</span><span class="token punctuation">(</span>_callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> _context<span class="token punctuation">;</span>
    <span class="token keyword">var</span> _x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_x<span class="token punctuation">;</span>
    <span class="token keyword">var</span> _fn0 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">_fn0</span><span class="token punctuation">(</span>_err0 <span class="token operator">=</span> <span class="token operator">&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_err0<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">_callback</span><span class="token punctuation">(</span>_err0<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> _fn1 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">_fn1</span><span class="token punctuation">(</span>_err1 <span class="token operator">=</span> <span class="token operator">&gt;</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>_err1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">_callback</span><span class="token punctuation">(</span>_err1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">_callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>串行执行 handler，handler 参数的最后一个是 next 函数，必须手动执行，才会走到下面的逻辑。callback 的执行是根据 next是否传参决定的。由之前的 <a href="http://localhost:8080/blog/code/webpack/source-code-prepare/tapable-0.2.html" target="_blank" rel="noopener noreferrer">tapbale-0.2.8源码分析<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>来看，<strong>之前为了实现异步的钩子，都需要函数内部有个递归调用的过程，现在编译之后，所有的逻辑都扁平化了，不会引起递归占用过多的空间的问题。这也是重构的好处。</strong></p> <h3 id="asyncserieswaterfallhook（异步串行瀑布钩子）"><a href="#asyncserieswaterfallhook（异步串行瀑布钩子）" aria-hidden="true" class="header-anchor">#</a> AsyncSeriesWaterfallHook（异步串行瀑布钩子）</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> ash <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesWaterfallHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

ash<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'来自 handler 1 的参数'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
ash<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'来自 handler 2 的参数'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
ash<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token string">'来自初始化的参数'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 打印如下</span>
来自初始化的参数
来自 handler <span class="token number">1</span> 的参数
来自 handler <span class="token number">2</span> 的参数
</code></pre></div><p><strong>编译的 fn 如下</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">anonymous</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> _callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> _context<span class="token punctuation">;</span>
    <span class="token keyword">var</span> _x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_x<span class="token punctuation">;</span>
    <span class="token keyword">var</span> _fn0 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">_fn0</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token punctuation">(</span>_err0<span class="token punctuation">,</span> _result0<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_err0<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">_callback</span><span class="token punctuation">(</span>_err0<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_result0 <span class="token operator">!==</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                name <span class="token operator">=</span> _result0<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">var</span> _fn1 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">_fn1</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token punctuation">(</span>_err1<span class="token punctuation">,</span> _result1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&gt;</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>_err1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">_callback</span><span class="token punctuation">(</span>_err1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>_result1 <span class="token operator">!==</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        name <span class="token operator">=</span> _result1<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">_callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>异步串行执行 handler，handler 参数的最后一个是 next 函数，必须手动执行，才会走到下面的逻辑。callback 的执行是根据 next是否传参决定的。第一个参数是 error，第二个参数是传给下一个 handler 的值，如果 error 存在的话，直接会执行 callback。</p> <h2 id="同异步钩子类的总结"><a href="#同异步钩子类的总结" aria-hidden="true" class="header-anchor">#</a> 同异步钩子类的总结</h2> <p>分析了所有的同异步钩子，根据之前的 tapable 版本，牵涉到异步执行的钩子，函数内部肯定是存在递归的，这样写起来容易让人看懂。然而 2.0.0-beta 版本采用字符串拼接的方法把递归部分给抹平了，而且还会缓存每次编译的生成的 fn。这样来说，空间占用就变少了，性能更好了。</p> <h2 id="tapable"><a href="#tapable" aria-hidden="true" class="header-anchor">#</a> Tapable</h2> <p>根据 <a href="http://localhost:8080/blog/code/webpack/source-code-prepare/tapable-0.2.html" target="_blank" rel="noopener noreferrer">tapbale-0.2.8 源码分析<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，Tapable 是唯一的类。那么 2.0.0-beta 版为了兼容之前的语法，应该怎么做呢。继续定位到 <code>Tapable.js</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;util&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> SyncBailHook <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./SyncBailHook&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">Tapable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 声明同步保险钩子</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_pluginCompat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;options&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 注册 handler，主要是为了将 pluginName camelize 化。</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>_pluginCompat<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span> <span class="token string">&quot;Tapable camelCase&quot;</span><span class="token punctuation">,</span>
			stage<span class="token punctuation">:</span> <span class="token number">100</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		options <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			options<span class="token punctuation">.</span>names<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
				options<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/[- ]([a-z])/g</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>str<span class="token punctuation">,</span> ch<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> ch<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 在 hooks 属性上对应的钩子上注册 handler</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>_pluginCompat<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span> <span class="token string">&quot;Tapable this.hooks&quot;</span><span class="token punctuation">,</span>
			stage<span class="token punctuation">:</span> <span class="token number">200</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		options <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">let</span> hook<span class="token punctuation">;</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> name <span class="token keyword">of</span> options<span class="token punctuation">.</span>names<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				hook <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>hook <span class="token operator">!==</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>hook <span class="token operator">!==</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">const</span> tapOpt <span class="token operator">=</span> <span class="token punctuation">{</span>
					name<span class="token punctuation">:</span> options<span class="token punctuation">.</span>fn<span class="token punctuation">.</span>name <span class="token operator">||</span> <span class="token string">&quot;unnamed compat plugin&quot;</span><span class="token punctuation">,</span>
					stage<span class="token punctuation">:</span> options<span class="token punctuation">.</span>stage <span class="token operator">||</span> <span class="token number">0</span>
				<span class="token punctuation">}</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token keyword">async</span><span class="token punctuation">)</span> hook<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span>tapOpt<span class="token punctuation">,</span> options<span class="token punctuation">.</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">else</span> hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>tapOpt<span class="token punctuation">,</span> options<span class="token punctuation">.</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Tapable<span class="token punctuation">;</span>

Tapable<span class="token punctuation">.</span><span class="token function-variable function">addCompatLayer</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">addCompatLayer</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	Tapable<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
	instance<span class="token punctuation">.</span>plugin <span class="token operator">=</span> Tapable<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>plugin<span class="token punctuation">;</span>
	instance<span class="token punctuation">.</span>apply <span class="token operator">=</span> Tapable<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>apply<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 注册 handler，实际上会走到 _pluginCompat 属性上的第二个 handler，进而在对应的 hooks 注册了 handler。</span>
Tapable<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>plugin <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">deprecate</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">plugin</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		name<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_pluginCompat<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
		name<span class="token punctuation">:</span> name<span class="token punctuation">,</span>
		fn<span class="token punctuation">:</span> fn<span class="token punctuation">,</span>
		names<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
			<span class="token template-string"><span class="token string">`Plugin could not be registered at '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'. Hook was not found.\n`</span></span> <span class="token operator">+</span>
				<span class="token string">&quot;BREAKING CHANGE: There need to exist a hook at 'this.hooks'. &quot;</span> <span class="token operator">+</span>
				<span class="token string">&quot;To create a compatibility layer for this hook, hook into 'this._pluginCompat'.&quot;</span>
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Tapable.plugin is deprecated. Use new API on `.hooks` instead&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Tapable<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>apply <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">deprecate</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		arguments<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Tapable.apply is deprecated. Call apply on the plugin directly instead&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Tapable 重构之后，为了兼容之前的版本，费了一点心思，首先 Tapable 上有个 _pluginCompat 属性是同步保险钩子，并且注册了两个 handler，这两个 handler 的触发时机是在于你调用 plugin 方法的时候，先将你传入的插件名 camelize 化，然后在 hooks 属性上寻找对应的钩子实例，并且调用 tap 方法真正注册 handler。</p> <p>这么做的目的在于什么呢？因为 webpack 的 Compiler 类就是继承于 Tapable，所以 webpack 与 Tapable 升级了，由于内部做了一定的兼容，不会对用户以前的 plugin 造成任何影响。所以用户不用再重写他们的 plugin 了。对于 webpack 开发插件，只需要提供带有 apply 方法的对象或者提供一个函数，插件在钩子实例上注册 handler 的时候，依然可以通过 compiler.plugin 来注册插件，但是命令行会打印出提示语句，提示你尽量使用新语法，可以看出插件升级之后的影响也是降到最低。</p> <h2 id="所获"><a href="#所获" aria-hidden="true" class="header-anchor">#</a> 所获</h2> <p>经过分析了 tapable-0.2.8 以及 tapable-2.0.0-beta 版本的源码，深刻地体会到作者 js 的功底之深厚，前一个版本对于 js 基础好一点的人都能写出来，但是后一个版本的整体架构设计，以及对前一个版本的兼容都是做的非常好的。之前看了 javascript 设计模式什么的，现在都觉得都是泛泛之谈，而真正能应用于实际场景才说明你对各种设计模式融会贯通，不是为了追求设计模式，在无形当中，你的感觉会带着你走，会写出高质量的代码。这也是<strong>大量阅读优秀源码</strong>的好处。比如 Vue、Vuex、Vue-Router 的架构设计，以及<a href="https://ustbhuangyi.github.io/vue-analysis/" target="_blank" rel="noopener noreferrer">这篇Vue源码解析<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/blog/code/webpack/source-code-prepare/tapable-0.2.html" class="prev">
          tapable(0.2.8 版本)
        </a></span> <span class="next"><a href="/blog/code/webpack/source-code/init.html">
          核心概念
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/blog/assets/js/19.4459fab3.js" defer></script><script src="/blog/assets/js/app.1527b53c.js" defer></script>
  </body>
</html>
