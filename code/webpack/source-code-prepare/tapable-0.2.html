<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>tapable(0.2.8 版本) | JiZhi</title>
    <meta name="description" content="每天都是充实的一天。">
    
    
    <link rel="preload" href="/blog/assets/css/styles.1527b53c.css" as="style"><link rel="preload" href="/blog/assets/js/app.1527b53c.js" as="script"><link rel="preload" href="/blog/assets/js/18.fdda8d80.js" as="script"><link rel="prefetch" href="/blog/assets/js/9.82a5e495.js"><link rel="prefetch" href="/blog/assets/css/1.styles.5a8ea794.css"><link rel="prefetch" href="/blog/assets/js/1.5a8ea794.js"><link rel="prefetch" href="/blog/assets/css/2.styles.354b08d3.css"><link rel="prefetch" href="/blog/assets/js/2.354b08d3.js"><link rel="prefetch" href="/blog/assets/js/3.2f7da517.js"><link rel="prefetch" href="/blog/assets/js/4.9ece7494.js"><link rel="prefetch" href="/blog/assets/js/5.7cbd655d.js"><link rel="prefetch" href="/blog/assets/js/6.5447cf44.js"><link rel="prefetch" href="/blog/assets/js/7.f8177327.js"><link rel="prefetch" href="/blog/assets/js/8.072cd75c.js"><link rel="prefetch" href="/blog/assets/js/10.a4300a64.js"><link rel="prefetch" href="/blog/assets/js/11.671860cc.js"><link rel="prefetch" href="/blog/assets/js/12.6f5779c5.js"><link rel="prefetch" href="/blog/assets/js/13.178f050d.js"><link rel="prefetch" href="/blog/assets/js/14.66b4a5f6.js"><link rel="prefetch" href="/blog/assets/js/15.d96648ea.js"><link rel="prefetch" href="/blog/assets/js/16.df7195c7.js"><link rel="prefetch" href="/blog/assets/js/17.a6c497f0.js"><link rel="prefetch" href="/blog/assets/js/19.4459fab3.js"><link rel="prefetch" href="/blog/assets/js/20.ccad1215.js"><link rel="prefetch" href="/blog/assets/js/21.da278b03.js">
    <link rel="stylesheet" href="/blog/assets/css/1.styles.5a8ea794.css"><link rel="stylesheet" href="/blog/assets/css/2.styles.354b08d3.css"><link rel="stylesheet" href="/blog/assets/css/styles.1527b53c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">JiZhi</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/code/vue/vuex.html" class="nav-link">编程</a></div><div class="nav-item"><a href="/blog/books/literature/lostParadise.html" class="nav-link">书籍</a></div><div class="nav-item"><a href="/blog/articles/index.html" class="nav-link">文章</a></div><div class="nav-item"><a href="/blog/sources/index.html" class="nav-link">资源</a></div><div class="nav-item"><a href="https://github.com/theniceangel" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/code/vue/vuex.html" class="nav-link">编程</a></div><div class="nav-item"><a href="/blog/books/literature/lostParadise.html" class="nav-link">书籍</a></div><div class="nav-item"><a href="/blog/articles/index.html" class="nav-link">文章</a></div><div class="nav-item"><a href="/blog/sources/index.html" class="nav-link">资源</a></div><div class="nav-item"><a href="https://github.com/theniceangel" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading"><span>软件素养</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/code/software/uml-class-design.html" class="sidebar-link">UML 之类图</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>数据结构</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/code/data-structure/binary-tree.html" class="sidebar-link">二叉树</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Vue</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/code/vue/vuex.html" class="sidebar-link">vuex</a></li><li><a href="/blog/code/vue/vue-router.html" class="sidebar-link">Vue-Router</a></li><li><a href="/blog/code/vue/vue-array-optimize.html" class="sidebar-link">Vue 性能优化之深挖数组</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>源码篇</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/code/sources/default.html" class="sidebar-link">webpack 学习篇</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>异步编程</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/code/async/co.html" class="sidebar-link">co 库</a></li><li><a href="/blog/code/async/promise.html" class="sidebar-link">怎样实现 Promise</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading open"><span>webpack 源码之准备篇</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/code/webpack/source-code-prepare/tapable-0.2.html" class="active sidebar-link">tapable(0.2.8 版本)</a></li><li><a href="/blog/code/webpack/source-code-prepare/tapable-2.0.html" class="sidebar-link">tapable (2.0.0-beta 版本)</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>webpack 源码之分析篇</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/code/webpack/source-code/init.html" class="sidebar-link">核心概念</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>webpack 源码之 Class 篇</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/code/webpack/source-code-class/dependency.html" class="sidebar-link">Dependency 及其衍生类</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>杂项</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/code/others/minipack.html" class="sidebar-link">手写 mini 打包工具</a></li><li><a href="/blog/code/others/flatten-array.html" class="sidebar-link">扁平化多维数组的不同实现方式</a></li><li><a href="/blog/code/others/regex.html" class="sidebar-link">正则收集</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="tapable-0-2-8-版本"><a href="#tapable-0-2-8-版本" aria-hidden="true" class="header-anchor">#</a> tapable(0.2.8 版本)</h1> <p>webpack 是基于事件流的打包构建工具，也就是内置了很多 hooks。作为使用方，可以在这些钩子当中，去插入自己的处理逻辑，而这一切的实现都得益于 tapable 这个工具。它有多个版本，webpack 前期的版本是依赖于 tapable 0.2.8 这个版本，后来重构了，发了 2.0.0 beta 版本，因为源码都是通过字符串拼接，通过 new Function 的模式使用，所以看起来比较晦涩。</p> <p>那么既然如此，我们先从早期的 0.2.8 这个版本了解下它的前身，毕竟核心思想不会发生太大的变化。</p> <p>tapable 的实现类似于 node 的 EventEmitter 的发布订阅模式。用一个对象的键存储对应的事件名称，键值来存储事件的处理函数，类似于下面：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Tapable</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_plugins <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'emit'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>handler1<span class="token punctuation">,</span> handler2<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token operator">...</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>同时，原型上定义了不同的方法来调用 handlers。</p> <p>我们先来看下用法，</p> <ol><li><p><strong>plugin</strong> 与 <strong>applyPlugins</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">void</span> <span class="token function">plugin</span><span class="token punctuation">(</span>names<span class="token punctuation">:</span> string<span class="token operator">|</span>string<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> handler<span class="token punctuation">:</span> Function<span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">applyPlugins</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> string<span class="token punctuation">,</span> args<span class="token punctuation">:</span> any<span class="token operator">...</span><span class="token punctuation">)</span>
</code></pre></div><p>最基础的就是注册插件以及插件触发的回调函数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Tapable <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tapable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 注册插件</span>
t<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'emit'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'This is a emit handler'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 调用插件</span>
t<span class="token punctuation">.</span><span class="token function">applyPlugins</span><span class="token punctuation">(</span><span class="token string">'emit'</span><span class="token punctuation">,</span> <span class="token string">'参数1'</span><span class="token punctuation">)</span>

<span class="token comment">// 打印如下</span>
<span class="token punctuation">[</span> <span class="token string">'参数1'</span> <span class="token punctuation">]</span>
This is a emit handler
</code></pre></div><p><strong>源码如下</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>Tapable<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">applyPlugins</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">applyPlugins</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_plugins<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> args <span class="token operator">=</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> plugins <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_plugins<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> plugins<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    plugins<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

Tapable<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">plugin</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">plugin</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_plugins<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_plugins<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>fn<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_plugins<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>很简单，内部维护 _plugins 属性来缓存 plugin 名称以及 handler。</p></li> <li><p><strong>apply</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span>plugins<span class="token punctuation">:</span> Plugin<span class="token operator">...</span><span class="token punctuation">)</span>
</code></pre></div><p>接收 plugin 作为参数，每个 plugin 必须提供 apply 方法，也就是 webpack 在编写 plugin 的规是插件实例必须提供 apply 方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Tapable <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tapable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 声明一个 webpack 插件的类，对象必须声明 apply 方法</span>
<span class="token keyword">class</span> <span class="token class-name">WebpackPlugin</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">apply</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'This is webpackPlugin'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> plugin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// tapable.apply</span>
t<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span> <span class="token comment">// print 'This is webpackPlugin'</span>
</code></pre></div><p><strong>源码如下</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>Tapable<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">apply</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    arguments<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>也很简单，依次执行每个插件的 apply 方法。</p></li> <li><p><strong>applyPluginsWaterfall</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>any <span class="token function">applyPluginsWaterfall</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> string<span class="token punctuation">,</span> init<span class="token punctuation">:</span> any<span class="token punctuation">,</span> args<span class="token punctuation">:</span> any<span class="token operator">...</span><span class="token punctuation">)</span>
</code></pre></div><p>依次调用插件对应的 handler，传入的参数是上一个 handler 的返回值，以及调用 applyPluginsWaterfall 传入 args 参数组成的数组，说起来很绕，看看下面的例子：</p> <div class="language-js extra-class"><pre class="language-js"><code>t<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'waterfall'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// print ['init', 'args1']</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token string">'result1'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

t<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'waterfall'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// print ['result1', 'args1']</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token string">'result2'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> ret <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">applyPluginsWaterfall</span><span class="token punctuation">(</span><span class="token string">'waterfall'</span><span class="token punctuation">,</span> <span class="token string">'init'</span><span class="token punctuation">,</span> <span class="token string">'args1'</span><span class="token punctuation">)</span> <span class="token comment">// ret =&gt; 'result2'</span>
</code></pre></div><p><strong>源码如下</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>Tapable<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">applyPluginsWaterfall</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">applyPluginsWaterfall</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> init<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_plugins<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> init<span class="token punctuation">;</span>
  <span class="token keyword">var</span> args <span class="token operator">=</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> plugins <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_plugins<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> current <span class="token operator">=</span> init<span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> plugins<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> current<span class="token punctuation">;</span>
    current <span class="token operator">=</span> plugins<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> current<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>上一个 handler 返回的值，会作为下一个 handler的第一个参数。</p></li> <li><p><strong>applyPluginsBailResult</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>any <span class="token function">applyPluginsBailResult</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> string<span class="token punctuation">,</span> args<span class="token punctuation">:</span> any<span class="token operator">...</span><span class="token punctuation">)</span>
</code></pre></div><p>依次调用插件对应的 handler，传入的参数是 args，如果正执行的 handler 的 返回值不是 undefined，其余的 handler 都不会执行了。 <code>bail</code> 是保险的意思，即只要任意一个 handler 有 <code>!== undefined</code> 的返回值，那么函数的执行就终止了。</p> <div class="language-js extra-class"><pre class="language-js"><code>t<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'bailResult'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// [ '参数1', '参数2' ]</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token string">'result1'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

t<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'bailResult'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 因为上一个函数返回了 'result1'，所以不会执行到这个handler</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token string">'result2'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

t<span class="token punctuation">.</span><span class="token function">applyPluginsBailResult</span><span class="token punctuation">(</span><span class="token string">'bailResult'</span><span class="token punctuation">,</span> <span class="token string">'参数1'</span><span class="token punctuation">,</span> <span class="token string">'参数2'</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>源码如下</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>Tapable<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">applyPluginsBailResult</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">applyPluginsBailResult</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> init<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_plugins<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> args <span class="token operator">=</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> plugins <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_plugins<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> plugins<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> plugins<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> result <span class="token operator">!==</span> <span class="token string">&quot;undefined&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>只要 handler 返回的值 <code>!== undefined</code>，就会停止调用接下来的 handler。</p></li> <li><p><strong>applyPluginsAsyncSeries &amp; applyPluginsAsync</strong>（支持异步）</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">void</span> <span class="token function">applyPluginsAsync</span><span class="token punctuation">(</span>
  name<span class="token punctuation">:</span> string<span class="token punctuation">,</span>
  args<span class="token punctuation">:</span> any<span class="token operator">...</span><span class="token punctuation">,</span>
  callback<span class="token punctuation">:</span> <span class="token punctuation">(</span>err<span class="token operator">?</span><span class="token punctuation">:</span> Error<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">void</span>
<span class="token punctuation">)</span>
</code></pre></div><p>applyPluginsAsyncSeries 与 applyPluginsAsync 的函数引用都是相同的，并且函数内部支持异步。callback 在所有 handler 都执行完了才会调用，但是在注册 handler 的时候，函数内部一定要执行 next() 的逻辑，这样才能执行到下一个 handler。</p> <div class="language-js extra-class"><pre class="language-js"><code>t<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'asyncSeries'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// handler 的最后一个参数一定是 next 函数</span>
  <span class="token keyword">const</span> next <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 执行 next，函数才会执行到下面的 handler</span>
  <span class="token function">setTimeout</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

t<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'asyncSeries'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// handler 的最后一个参数一定是 next</span>
  <span class="token keyword">const</span> callback <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 执行 next，函数才会执行到 applyPluginsAsyncSeries 传入的 callback</span>
  Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

t<span class="token punctuation">.</span><span class="token function">applyPluginsAsyncSeries</span><span class="token punctuation">(</span><span class="token string">'asyncSeries'</span><span class="token punctuation">,</span> <span class="token string">'参数1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'这是 applyPluginsAsyncSeries 的 callback'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>源码如下</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>Tapable<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>applyPluginsAsyncSeries <span class="token operator">=</span> Tapable<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">applyPluginsAsync</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">applyPluginsAsyncSeries</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> args <span class="token operator">=</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> callback <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> plugins <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_plugins<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>plugins <span class="token operator">||</span> plugins<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  args<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> plugins<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    plugins<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>_this<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  plugins<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>applyPluginsAsyncSeries 内部维护了一个 next 函数，这个函数作为每个 handler 的最后一个参数传入，handler 内部支持异步操作，但是必须手动调用 next 函数，才能执行到下一个 handler。</p></li> <li><p><strong>applyPluginsAsyncSeriesBailResult</strong>（支持异步）</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">void</span> <span class="token function">applyPluginsAsyncSeriesBailResult</span><span class="token punctuation">(</span>
  name<span class="token punctuation">:</span> string<span class="token punctuation">,</span>
  args<span class="token punctuation">:</span> any<span class="token operator">...</span><span class="token punctuation">,</span>
  callback<span class="token punctuation">:</span> <span class="token punctuation">(</span>result<span class="token punctuation">:</span> any<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">void</span>
<span class="token punctuation">)</span>
</code></pre></div><p>函数支持异步，只要在 handler 里面调用 next 回调函数，并且传入任意参数，就会直接执行 callback。</p> <div class="language-js extra-class"><pre class="language-js"><code>t<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'asyncSeriesBailResult'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// handler 的最后一个参数一定是 next 函数</span>
  <span class="token keyword">const</span> next <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 因为传了字符串，导致直接执行 callback</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token string">'跳过 handler 函数'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

t<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'asyncSeriesBailResult'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  
<span class="token punctuation">}</span><span class="token punctuation">)</span>

t<span class="token punctuation">.</span><span class="token function">applyPluginsAsyncSeriesBailResult</span><span class="token punctuation">(</span><span class="token string">'asyncSeriesBailResult'</span><span class="token punctuation">,</span> <span class="token string">'参数1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'这是 applyPluginsAsyncSeriesBailResult 的 callback'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// print '这是 applyPluginsAsyncSeriesBailResult 的 callback'</span>
</code></pre></div><p><strong>源码如下</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>Tapable<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">applyPluginsAsyncSeriesBailResult</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">applyPluginsAsyncSeriesBailResult</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> args <span class="token operator">=</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> callback <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_plugins<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_plugins<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> plugins <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_plugins<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  args<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> callback<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> plugins<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    plugins<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>_this<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  plugins<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>applyPluginsAsyncSeriesBailResult 内部维护了一个 next 函数，这个函数作为每个 handler 的最后一个参数传入，handler 内部支持异步操作，但是必须手动调用 next 函数，才能执行到下一个 handler，next 函数可以传入参数，这样会直接执行 callback。</p></li> <li><p><strong>applyPluginsAsyncWaterfall</strong>（支持异步）</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">void</span> <span class="token function">applyPluginsAsyncWaterfall</span><span class="token punctuation">(</span>
  name<span class="token punctuation">:</span> string<span class="token punctuation">,</span>
  init<span class="token punctuation">:</span> any<span class="token punctuation">,</span>
  callback<span class="token punctuation">:</span> <span class="token punctuation">(</span>err<span class="token punctuation">:</span> Error<span class="token punctuation">,</span> result<span class="token punctuation">:</span> any<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">void</span>
<span class="token punctuation">)</span>
</code></pre></div><p>函数支持异步，handler 的接收两个参数，第一个参数是上一个 handler 通过 next 函数传过来的 value，第二个参数是 next 函数。next 函数接收两个参数，第一个是 error，如果 error 存在，就直接执行 callback。第二个 value 参数，是传给下一个 handler 的参数。</p> <div class="language-js extra-class"><pre class="language-js"><code>t<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'asyncWaterfall'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>value<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="token comment">// handler 的最后一个参数一定是 next 函数</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'来自第一个 handler'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

t<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'asyncWaterfall'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>value<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'来自第二个 handler'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

t<span class="token punctuation">.</span><span class="token function">applyPluginsAsyncWaterfall</span><span class="token punctuation">(</span><span class="token string">'asyncWaterfall'</span><span class="token punctuation">,</span> <span class="token string">'参数1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 打印如下</span>

参数<span class="token number">1</span>
来自第一个 handler
来自第二个 handler
</code></pre></div><p><strong>源码如下</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>Tapable<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">applyPluginsAsyncWaterfall</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">applyPluginsAsyncWaterfall</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> init<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_plugins<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_plugins<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> init<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> plugins <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_plugins<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> next <span class="token operator">=</span> <span class="token function">copyProperties</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> plugins<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    plugins<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>_this<span class="token punctuation">,</span> value<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  plugins<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> init<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>applyPluginsAsyncWaterfall 内部维护了一个 next 函数，这个函数作为每个 handler 的最后一个参数传入，handler 内部支持异步操作，但是必须手动调用 next 函数，才能执行到下一个 handler，next 函数可以传入参数，第一个参数为 err， 第二参数为上一个 handler 返回值。</p></li> <li><p><strong>applyPluginsParallel</strong>（支持异步）</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">void</span> <span class="token function">applyPluginsParallel</span><span class="token punctuation">(</span>
  name<span class="token punctuation">:</span> string<span class="token punctuation">,</span>
  args<span class="token punctuation">:</span> any<span class="token operator">...</span><span class="token punctuation">,</span>
  callback<span class="token punctuation">:</span> <span class="token punctuation">(</span>err<span class="token operator">?</span><span class="token punctuation">:</span> Error<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">void</span>
<span class="token punctuation">)</span>
</code></pre></div><p>并行的执行函数，每个 handler 的最后一个参数都是 next 函数，这个函数用来检验当前的 handler 是否已经执行完。</p> <div class="language-js extra-class"><pre class="language-js"><code>t<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'parallel'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> next <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token comment">// 必须调用 next 函数，要不然 applyPluginsParallel 的 callback 永远也不会回调</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token string">'抛出错误了1'</span><span class="token punctuation">,</span> <span class="token string">'来自第一个 handler'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

t<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'parallel'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> next <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token comment">// 必须调用 next 函数，要不然 applyPluginsParallel 的 callback 永远也不会回调</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token string">'抛出错误了2'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

t<span class="token punctuation">.</span><span class="token function">applyPluginsParallel</span><span class="token punctuation">(</span><span class="token string">'parallel'</span><span class="token punctuation">,</span> <span class="token string">'参数1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// print '抛出错误了1'</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>源码如下</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>Tapable<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">applyPluginsParallel</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">applyPluginsParallel</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> args <span class="token operator">=</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> callback <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_plugins<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_plugins<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> plugins <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_plugins<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> remaining <span class="token operator">=</span> plugins<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  args<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>remaining <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// ignore</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      remaining <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    remaining<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>remaining <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> plugins<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    plugins<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>remaining <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>applyPluginsParallel 并行地调用 handler。内部通过闭包维护了 remaining 变量，用来判断内部的函数是否真正执行完，handler 的最后一个参数是一个函数 check。如果 handler 内部用户想要的逻辑执行完，必须调用 check 函数来告诉 tapable，进而才会执行 args 数组的最后一个 check 函数。</p></li> <li><p>** applyPluginsParallelBailResult **（支持异步）</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">void</span> <span class="token function">applyPluginsParallelBailResult</span><span class="token punctuation">(</span>
  name<span class="token punctuation">:</span> string<span class="token punctuation">,</span>
  args<span class="token punctuation">:</span> any<span class="token operator">...</span><span class="token punctuation">,</span>
  callback<span class="token punctuation">:</span> <span class="token punctuation">(</span>err<span class="token punctuation">:</span> Error<span class="token punctuation">,</span> result<span class="token punctuation">:</span> any<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">void</span>
<span class="token punctuation">)</span>
</code></pre></div><p>并行的执行函数，每个 handler 的最后一个参数都是 next 函数，next 函数必须调用，如果给 next 函数传参，会直接走到 callback 的逻辑。callback 执行的时机是跟 handler 注册的顺序有关，而不是跟 handler 内部调用 next 的时机有关。</p> <div class="language-js extra-class"><pre class="language-js"><code>t<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'applyPluginsParallelBailResult'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token string">'has args 1'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

t<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'applyPluginsParallelBailResult'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token string">'has args 2'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

t<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'applyPluginsParallelBailResult'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token string">'has args 3'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

t<span class="token punctuation">.</span><span class="token function">applyPluginsParallelBailResult</span><span class="token punctuation">(</span><span class="token string">'applyPluginsParallelBailResult'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 打印如下</span>
<span class="token number">1</span>
<span class="token number">2</span>
<span class="token number">3</span>
has args <span class="token number">1</span>

虽然第一个 handler 的 next 函数是延迟 <span class="token number">3</span>s 才执行，但是注册的顺序是在最前面，所以 callback 的 result 参数值是 <span class="token string">'has args 1'</span>。
</code></pre></div><p><strong>源码如下</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>Tapable<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">applyPluginsParallelBailResult</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">applyPluginsParallelBailResult</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> args <span class="token operator">=</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> callback <span class="token operator">=</span> args<span class="token punctuation">[</span>args<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_plugins<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_plugins<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> plugins <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_plugins<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> currentPos <span class="token operator">=</span> plugins<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token keyword">var</span> currentResult<span class="token punctuation">;</span>
  <span class="token keyword">var</span> done <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> plugins<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    args<span class="token punctuation">[</span>args<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">copyProperties</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> currentPos<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// ignore</span>
        done<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          currentPos <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
          done <span class="token operator">=</span> fastFilter<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>done<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> item <span class="token operator">&lt;=</span> i<span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          currentResult <span class="token operator">=</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>done<span class="token punctuation">.</span>length <span class="token operator">===</span> currentPos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          callback<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> currentResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
          currentPos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    plugins<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>for 循环里面并行的执行 handler，handler 的最后一个参数是一个匿名回调函数，这个匿名函数必须在 handler 里面手动的执行。而 callback 的执行时机就是根据 handler 的注册顺序有关。</p></li></ol> <p>从源码上来看，tapable 是提供了很多 API 来对应不同调用 handler 的场景，有同步执行，有异步执行，还有串行异步，并行异步等。这些都是一些高级的技巧，不管是 express，还是 VueRouter 的源码，都利用这些同异步执行机制，但是可以看出程序是有边界的。也就是约定成俗，从最后一个 applyPluginsParallel 函数来看，用户必须调用 check 函数，否则 tapable 怎么知道你内部是否有异步操作，并且异步操作在某个时候执行完了呢。</p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/blog/code/async/promise.html" class="prev">
          怎样实现 Promise
        </a></span> <span class="next"><a href="/blog/code/webpack/source-code-prepare/tapable-2.0.html">
          tapable (2.0.0-beta 版本)
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/blog/assets/js/18.fdda8d80.js" defer></script><script src="/blog/assets/js/app.1527b53c.js" defer></script>
  </body>
</html>
